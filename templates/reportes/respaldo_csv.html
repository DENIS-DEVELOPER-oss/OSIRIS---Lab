{% extends "modern_base.html" %}

{% block title %}Gestión de Respaldo CSV - Sistema Médico Universitario{% endblock %}

{% block extra_css %}
<style>
    .action-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: var(--text-dark);
        border-radius: var(--border-radius-lg);
        padding: 25px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: var(--shadow-glow);
    }
    .csv-info {
        background: var(--bg-card);
        border-radius: var(--border-radius);
        padding: 20px;
        border-left: 4px solid var(--success-color);
        backdrop-filter: blur(10px);
        border: var(--border-primary);
    }
    .warning-section {
        background: rgba(243, 156, 18, 0.1);
        border: 1px solid var(--warning-color);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
    }
</style>
{% endblock %}

{% block content %}
<div class="modern-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class='bx bx-file-export'></i>
            Gestión de Respaldo CSV
        </h2>
        <a href="{{ url_for('reportes.dashboard_admin') }}" class="modern-btn btn-secondary">
            <i class='bx bx-arrow-back'></i> Volver al Dashboard
        </a>
    </div>

    <!-- Información del Sistema CSV -->
    <div class="action-card">
        <h4><i class='bx bx-database'></i> Sistema de Respaldo Automático</h4>
        <p class="mb-0">Cada usuario creado se guarda automáticamente en archivo CSV como respaldo. También puedes importar usuarios desde archivo CSV.</p>
    </div>

    <!-- Estadísticas del Archivo CSV -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class='bx bx-file'></i>
            </div>
            <div class="stat-number">
                {% if estadisticas.existe_archivo %}
                    <i class='bx bx-check-circle' style="color: var(--success-color);"></i>
                {% else %}
                    <i class='bx bx-x-circle' style="color: var(--danger-color);"></i>
                {% endif %}
            </div>
            <div class="stat-label">
                {% if estadisticas.existe_archivo %}
                    Archivo Disponible
                {% else %}
                    Archivo No Existe
                {% endif %}
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class='bx bx-users'></i>
            </div>
            <div class="stat-number">{{ estadisticas.total_registros }}</div>
            <div class="stat-label">Registros en CSV</div>
        </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-calendar fa-3x text-info mb-3"></i>
                    <h5>Última Modificación</h5>
                    <h6 class="text-info">
                        {% if estadisticas.fecha_modificacion %}
                            {{ estadisticas.fecha_modificacion.strftime('%d/%m/%Y') }}<br>
                            <small>{{ estadisticas.fecha_modificacion.strftime('%H:%M:%S') }}</small>
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                    </h6>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-hdd fa-3x text-warning mb-3"></i>
                    <h5>Tamaño del Archivo</h5>
                    <h6 class="text-warning">
                        {% if estadisticas.tamaño_archivo %}
                            {% if estadisticas.tamaño_archivo < 1024 %}
                                {{ estadisticas.tamaño_archivo }} bytes
                            {% elif estadisticas.tamaño_archivo < 1048576 %}
                                {{ "%.1f"|format(estadisticas.tamaño_archivo / 1024) }} KB
                            {% else %}
                                {{ "%.1f"|format(estadisticas.tamaño_archivo / 1048576) }} MB
                            {% endif %}
                        {% else %}
                            <span class="text-muted">0 bytes</span>
                        {% endif %}
                    </h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Información sobre CSV -->
    <div class="csv-info mb-4">
        <h6><i class="fas fa-info-circle"></i> Información del Sistema CSV</h6>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Archivo:</strong> usuarios_respaldo.csv</p>
                <p><strong>Ubicación:</strong> Directorio raíz del proyecto</p>
                <p><strong>Codificación:</strong> UTF-8</p>
            </div>
            <div class="col-md-6">
                <p><strong>Backup Automático:</strong> Activo</p>
                <p><strong>Campos:</strong> 8 columnas de datos</p>
                <p><strong>Formato:</strong> CSV estándar con headers</p>
            </div>
        </div>
    </div>

    <!-- Advertencias -->
    <div class="warning-section">
        <h6><i class="fas fa-exclamation-triangle"></i> Advertencias Importantes</h6>
        <ul class="mb-0">
            <li>Las contraseñas se guardan encriptadas (hash) en el archivo CSV</li>
            <li>Al importar desde CSV, solo se crearán usuarios que no existan en la base de datos</li>
            <li>El archivo CSV se actualiza automáticamente cada vez que se crea un usuario</li>
            <li>Mantenga el archivo CSV en un lugar seguro como respaldo</li>
        </ul>
    </div>

    <!-- Acciones Disponibles -->
    <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-download"></i> Exportar a CSV
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Exportar todos los usuarios de la base de datos al archivo CSV. Esto sobrescribirá el archivo existente.</p>
                    <a href="{{ url_for('reportes.exportar_usuarios_csv') }}" 
                       class="btn btn-success btn-block"
                       onclick="return confirm('¿Está seguro de exportar todos los usuarios al CSV? Esto sobrescribirá el archivo existente.')">
                        <i class="fas fa-download"></i> Exportar Usuarios
                    </a>
                </div>
                <div class="card-footer text-muted">
                    <small><i class="fas fa-info-circle"></i> Recomendado antes de realizar cambios importantes</small>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-upload"></i> Importar desde CSV
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Cargar usuarios desde el archivo CSV a la base de datos. Solo se crearán usuarios nuevos.</p>
                    <a href="{{ url_for('reportes.importar_usuarios_csv') }}" 
                       class="btn btn-primary btn-block"
                       onclick="return confirm('¿Está seguro de importar usuarios desde el CSV? Solo se crearán usuarios que no existan.')">
                        <i class="fas fa-upload"></i> Importar Usuarios
                    </a>
                </div>
                <div class="card-footer text-muted">
                    <small><i class="fas fa-shield-alt"></i> No duplica usuarios existentes</small>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sync"></i> Sincronizar
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Sincronizar el archivo CSV con la base de datos actual. Actualiza el CSV con todos los usuarios.</p>
                    <a href="{{ url_for('reportes.sincronizar_csv') }}" 
                       class="btn btn-info btn-block"
                       onclick="return confirm('¿Está seguro de sincronizar el CSV con la base de datos?')">
                        <i class="fas fa-sync"></i> Sincronizar CSV
                    </a>
                </div>
                <div class="card-footer text-muted">
                    <small><i class="fas fa-balance-scale"></i> Mantiene datos actualizados</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Instrucciones de Uso -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-book"></i> Instrucciones de Uso
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-play-circle"></i> Flujo Recomendado:</h6>
                            <ol>
                                <li>Los usuarios se guardan automáticamente en CSV al crearlos</li>
                                <li>Use "Exportar" para crear un respaldo completo</li>
                                <li>Use "Importar" para restaurar usuarios desde respaldo</li>
                                <li>Use "Sincronizar" para mantener el CSV actualizado</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-cogs"></i> Casos de Uso:</h6>
                            <ul>
                                <li><strong>Respaldo:</strong> Exportar usuarios antes de cambios</li>
                                <li><strong>Restauración:</strong> Importar usuarios desde backup</li>
                                <li><strong>Migración:</strong> Transferir usuarios entre sistemas</li>
                                <li><strong>Auditoría:</strong> Revisar historial de usuarios</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Actualizar página automáticamente después de operaciones
document.addEventListener('DOMContentLoaded', function() {
    // Si hay mensajes flash, actualizar estadísticas después de 2 segundos
    const flashMessages = document.querySelectorAll('.alert');
    if (flashMessages.length > 0) {
        setTimeout(function() {
            // Recargar la página para mostrar estadísticas actualizadas
            window.location.reload();
        }, 3000);
    }
});

// Función para mostrar confirmaciones más detalladas
function confirmarAccion(accion, mensaje) {
    return confirm(`${accion}\n\n${mensaje}\n\n¿Desea continuar?`);
}

// Mejorar las confirmaciones de los botones
document.querySelectorAll('a[onclick*="confirm"]').forEach(function(link) {
    link.addEventListener('click', function(e) {
        const texto = this.textContent.trim();
        const icono = this.querySelector('i').className;
        
        let titulo, detalle;
        
        if (texto.includes('Exportar')) {
            titulo = 'Exportar Usuarios a CSV';
            detalle = 'Esta acción creará/sobrescribirá el archivo usuarios_respaldo.csv con todos los usuarios de la base de datos.';
        } else if (texto.includes('Importar')) {
            titulo = 'Importar Usuarios desde CSV';
            detalle = 'Esta acción leerá el archivo CSV y creará usuarios que no existan en la base de datos. No modificará usuarios existentes.';
        } else if (texto.includes('Sincronizar')) {
            titulo = 'Sincronizar CSV con Base de Datos';
            detalle = 'Esta acción actualizará el archivo CSV con todos los usuarios actuales de la base de datos.';
        }
        
        if (!confirmarAccion(titulo, detalle)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}