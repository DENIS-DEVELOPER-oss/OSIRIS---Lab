{% extends "admin_base.html" %}

{% block title %}Exportar Reportes - Sistema Médico Universitario{% endblock %}

{% block extra_css %}
<style>
    .export-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .export-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .export-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    .progress-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        display: none;
    }
    .format-selection {
        background: #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .date-filter {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">Exportar Reportes</h2>
                    <p class="text-muted">Generar y descargar reportes del sistema médico universitario</p>
                </div>
                <div>
                    <a href="{{ url_for('reportes.dashboard_admin') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver al Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de Fecha -->
    <div class="date-filter">
        <h5><i class="fas fa-filter"></i> Filtros de Fecha</h5>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="fechaInicio">Fecha de Inicio:</label>
                    <input type="date" id="fechaInicio" class="form-control">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="fechaFin">Fecha de Fin:</label>
                    <input type="date" id="fechaFin" class="form-control">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="periodoPreset">Periodo Predefinido:</label>
                    <select id="periodoPreset" class="form-control">
                        <option value="">Seleccionar periodo</option>
                        <option value="hoy">Hoy</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes">Este Mes</option>
                        <option value="trimestre">Este Trimestre</option>
                        <option value="año">Este Año</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-primary btn-block" onclick="aplicarFiltros()">
                        <i class="fas fa-search"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tipos de Reportes -->
    <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card export-card text-center h-100" onclick="exportarReporte('citas-general')">
                <div class="card-body">
                    <i class="fas fa-calendar-alt export-icon text-primary"></i>
                    <h5 class="card-title">Reporte General de Citas</h5>
                    <p class="card-text">Incluye todas las citas programadas, estados y tipos de consulta.</p>
                    <div class="format-selection">
                        <small class="text-muted">Formatos disponibles:</small><br>
                        <span class="badge badge-success">Excel</span>
                        <span class="badge badge-danger">PDF</span>
                        <span class="badge badge-info">CSV</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card export-card text-center h-100" onclick="exportarReporte('consultas-detallado')">
                <div class="card-body">
                    <i class="fas fa-stethoscope export-icon text-success"></i>
                    <h5 class="card-title">Reporte Detallado de Consultas</h5>
                    <p class="card-text">Diagnósticos, tratamientos y niveles de riesgo de todas las consultas.</p>
                    <div class="format-selection">
                        <small class="text-muted">Formatos disponibles:</small><br>
                        <span class="badge badge-success">Excel</span>
                        <span class="badge badge-danger">PDF</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card export-card text-center h-100" onclick="exportarReporte('pacientes-resumen')">
                <div class="card-body">
                    <i class="fas fa-user-graduate export-icon text-info"></i>
                    <h5 class="card-title">Resumen de Pacientes</h5>
                    <p class="card-text">Información de estudiantes registrados y su historial médico.</p>
                    <div class="format-selection">
                        <small class="text-muted">Formatos disponibles:</small><br>
                        <span class="badge badge-success">Excel</span>
                        <span class="badge badge-info">CSV</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card export-card text-center h-100" onclick="exportarReporte('profesionales-rendimiento')">
                <div class="card-body">
                    <i class="fas fa-user-md export-icon text-warning"></i>
                    <h5 class="card-title">Rendimiento de Profesionales</h5>
                    <p class="card-text">Estadísticas de productividad y eficiencia de profesionales médicos.</p>
                    <div class="format-selection">
                        <small class="text-muted">Formatos disponibles:</small><br>
                        <span class="badge badge-success">Excel</span>
                        <span class="badge badge-danger">PDF</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card export-card text-center h-100" onclick="exportarReporte('estadisticas-carreras')">
                <div class="card-body">
                    <i class="fas fa-graduation-cap export-icon text-purple"></i>
                    <h5 class="card-title">Estadísticas por Carrera</h5>
                    <p class="card-text">Análisis de consultas médicas agrupadas por carrera universitaria.</p>
                    <div class="format-selection">
                        <small class="text-muted">Formatos disponibles:</small><br>
                        <span class="badge badge-success">Excel</span>
                        <span class="badge badge-danger">PDF</span>
                        <span class="badge badge-info">CSV</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card export-card text-center h-100" onclick="exportarReporte('niveles-riesgo')">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle export-icon text-danger"></i>
                    <h5 class="card-title">Reporte de Niveles de Riesgo</h5>
                    <p class="card-text">Consultas clasificadas por nivel de riesgo y seguimiento requerido.</p>
                    <div class="format-selection">
                        <small class="text-muted">Formatos disponibles:</small><br>
                        <span class="badge badge-success">Excel</span>
                        <span class="badge badge-danger">PDF</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reportes Avanzados -->
    <div class="row mt-4">
        <div class="col-12">
            <h4><i class="fas fa-chart-bar"></i> Reportes Avanzados</h4>
            <hr>
        </div>
        
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="card export-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line"></i> Reporte Personalizado
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Crear un reporte personalizado seleccionando campos específicos.</p>
                    
                    <div class="form-group">
                        <label>Seleccionar Campos:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="campo-pacientes" checked>
                                    <label class="custom-control-label" for="campo-pacientes">Información de Pacientes</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="campo-citas" checked>
                                    <label class="custom-control-label" for="campo-citas">Datos de Citas</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="campo-consultas">
                                    <label class="custom-control-label" for="campo-consultas">Detalles de Consultas</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="campo-profesionales">
                                    <label class="custom-control-label" for="campo-profesionales">Datos de Profesionales</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="campo-estadisticas">
                                    <label class="custom-control-label" for="campo-estadisticas">Estadísticas Generales</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="campo-horarios">
                                    <label class="custom-control-label" for="campo-horarios">Análisis de Horarios</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="generarReportePersonalizado()">
                        <i class="fas fa-cog"></i> Generar Reporte Personalizado
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-6 col-md-12 mb-4">
            <div class="card export-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock"></i> Reportes Programados
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Configurar reportes automáticos que se generen periódicamente.</p>
                    
                    <div class="form-group">
                        <label for="tipoReporteProgramado">Tipo de Reporte:</label>
                        <select id="tipoReporteProgramado" class="form-control">
                            <option value="">Seleccionar tipo</option>
                            <option value="citas-semanal">Citas Semanales</option>
                            <option value="consultas-mensual">Consultas Mensuales</option>
                            <option value="estadisticas-trimestral">Estadísticas Trimestrales</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="frecuenciaProgramada">Frecuencia:</label>
                        <select id="frecuenciaProgramada" class="form-control">
                            <option value="semanal">Semanal</option>
                            <option value="mensual">Mensual</option>
                            <option value="trimestral">Trimestral</option>
                        </select>
                    </div>
                    
                    <button type="button" class="btn btn-success" onclick="programarReporte()">
                        <i class="fas fa-calendar-plus"></i> Programar Reporte
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Progreso -->
    <div class="progress-section" id="progressSection">
        <h5><i class="fas fa-download"></i> Generando Reporte</h5>
        <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%" id="progressBar">
                0%
            </div>
        </div>
        <p id="progressText">Iniciando generación del reporte...</p>
        <button type="button" class="btn btn-secondary" onclick="cancelarExportacion()">
            <i class="fas fa-times"></i> Cancelar
        </button>
    </div>

    <!-- Modal de Selección de Formato -->
    <div class="modal fade" id="modalFormato" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Seleccionar Formato de Exportación</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Seleccione el formato en el que desea exportar el reporte:</p>
                    <div class="form-group">
                        <div class="custom-control custom-radio">
                            <input type="radio" id="formatoExcel" name="formato" class="custom-control-input" value="excel" checked>
                            <label class="custom-control-label" for="formatoExcel">
                                <i class="fas fa-file-excel text-success"></i> Excel (.xlsx)
                            </label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="formatoPDF" name="formato" class="custom-control-input" value="pdf">
                            <label class="custom-control-label" for="formatoPDF">
                                <i class="fas fa-file-pdf text-danger"></i> PDF (.pdf)
                            </label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="formatoCSV" name="formato" class="custom-control-input" value="csv">
                            <label class="custom-control-label" for="formatoCSV">
                                <i class="fas fa-file-csv text-info"></i> CSV (.csv)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarExportacion()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let tipoReporteActual = '';

// Función para aplicar filtros de fecha
function aplicarFiltros() {
    const periodo = document.getElementById('periodoPreset').value;
    const fechaInicio = document.getElementById('fechaInicio');
    const fechaFin = document.getElementById('fechaFin');
    
    if (periodo) {
        const hoy = new Date();
        let inicio, fin;
        
        switch(periodo) {
            case 'hoy':
                inicio = fin = hoy.toISOString().split('T')[0];
                break;
            case 'semana':
                inicio = new Date(hoy.setDate(hoy.getDate() - hoy.getDay())).toISOString().split('T')[0];
                fin = new Date(hoy.setDate(hoy.getDate() + 6)).toISOString().split('T')[0];
                break;
            case 'mes':
                inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
                fin = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).toISOString().split('T')[0];
                break;
            case 'trimestre':
                const trimestre = Math.floor(hoy.getMonth() / 3);
                inicio = new Date(hoy.getFullYear(), trimestre * 3, 1).toISOString().split('T')[0];
                fin = new Date(hoy.getFullYear(), trimestre * 3 + 3, 0).toISOString().split('T')[0];
                break;
            case 'año':
                inicio = new Date(hoy.getFullYear(), 0, 1).toISOString().split('T')[0];
                fin = new Date(hoy.getFullYear(), 11, 31).toISOString().split('T')[0];
                break;
        }
        
        fechaInicio.value = inicio;
        fechaFin.value = fin;
    }
    
    mostrarMensaje('Filtros aplicados correctamente', 'success');
}

// Función para exportar reporte
function exportarReporte(tipo) {
    tipoReporteActual = tipo;
    const modal = new bootstrap.Modal(document.getElementById('modalFormato'));
    modal.show();
}

// Función para confirmar exportación
function confirmarExportacion() {
    const formato = document.querySelector('input[name="formato"]:checked').value;
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalFormato'));
    modal.hide();
    
    // Mostrar sección de progreso
    const progressSection = document.getElementById('progressSection');
    progressSection.style.display = 'block';
    
    // Simular proceso de exportación
    simularExportacion(tipoReporteActual, formato, fechaInicio, fechaFin);
}

// Función para simular exportación
function simularExportacion(tipo, formato, fechaInicio, fechaFin) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    let progreso = 0;
    const pasos = [
        'Recopilando datos...',
        'Procesando información...',
        'Generando reporte...',
        'Aplicando formato...',
        'Finalizando exportación...'
    ];
    
    const intervalo = setInterval(() => {
        progreso += 20;
        progressBar.style.width = progreso + '%';
        progressBar.textContent = progreso + '%';
        
        if (progreso <= 100) {
            const pasoActual = Math.floor((progreso - 1) / 20);
            if (pasos[pasoActual]) {
                progressText.textContent = pasos[pasoActual];
            }
        }
        
        if (progreso >= 100) {
            clearInterval(intervalo);
            setTimeout(() => {
                progressText.textContent = 'Reporte generado exitosamente. Descarga iniciada.';
                mostrarMensaje(`Reporte ${tipo} exportado en formato ${formato.toUpperCase()}`, 'success');
                
                // Ocultar sección de progreso después de 3 segundos
                setTimeout(() => {
                    document.getElementById('progressSection').style.display = 'none';
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                }, 3000);
            }, 1000);
        }
    }, 800);
}

// Función para cancelar exportación
function cancelarExportacion() {
    document.getElementById('progressSection').style.display = 'none';
    mostrarMensaje('Exportación cancelada', 'warning');
}

// Función para generar reporte personalizado
function generarReportePersonalizado() {
    const camposSeleccionados = [];
    document.querySelectorAll('input[id^="campo-"]:checked').forEach(input => {
        camposSeleccionados.push(input.id.replace('campo-', ''));
    });
    
    if (camposSeleccionados.length === 0) {
        mostrarMensaje('Debe seleccionar al menos un campo', 'warning');
        return;
    }
    
    tipoReporteActual = 'personalizado';
    const modal = new bootstrap.Modal(document.getElementById('modalFormato'));
    modal.show();
}

// Función para programar reporte
function programarReporte() {
    const tipo = document.getElementById('tipoReporteProgramado').value;
    const frecuencia = document.getElementById('frecuenciaProgramada').value;
    
    if (!tipo) {
        mostrarMensaje('Debe seleccionar un tipo de reporte', 'warning');
        return;
    }
    
    mostrarMensaje(`Reporte ${tipo} programado con frecuencia ${frecuencia}`, 'success');
}

// Función para mostrar mensajes
function mostrarMensaje(mensaje, tipo) {
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    alerta.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alerta.innerHTML = `
        ${mensaje}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.appendChild(alerta);
    
    setTimeout(() => {
        if (alerta.parentNode) {
            alerta.parentNode.removeChild(alerta);
        }
    }, 5000);
}

// Event listener para preset de periodo
document.getElementById('periodoPreset').addEventListener('change', function() {
    if (this.value) {
        aplicarFiltros();
    }
});
</script>
{% endblock %}