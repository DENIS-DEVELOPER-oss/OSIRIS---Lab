{% extends "admin_base.html" %}

{% block title %}Crear Usuario - Sistema Médico Universitario{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        border-left: 4px solid #007bff;
    }
    .campo-condicional {
        transition: all 0.3s ease;
    }
    .help-text {
        color: #6c757d;
        font-size: 0.875rem;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">Crear Nuevo Usuario</h2>
                    <p class="text-muted">Agregar usuario al sistema médico universitario</p>
                </div>
                <div>
                    <a href="{{ url_for('reportes.gestion_usuarios') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a Usuarios
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Creación -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-plus"></i> Información del Usuario
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="form-section mb-4">
                            <h6 class="mb-3"><i class="fas fa-user"></i> Datos Generales</h6>
                            
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    {{ form.nombre.label(class="form-label fw-bold") }}
                                    {{ form.nombre(class="form-control" + (" is-invalid" if form.nombre.errors else "")) }}
                                    {% if form.nombre.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.nombre.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        <i class="fas fa-info-circle"></i> Nombre completo del usuario
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    {{ form.rol.label(class="form-label fw-bold") }}
                                    {{ form.rol(class="form-select" + (" is-invalid" if form.rol.errors else ""), id="rolSelect") }}
                                    {% if form.rol.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.rol.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        <i class="fas fa-user-tag"></i> Determina los permisos del usuario
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section mb-4">
                            <h6 class="mb-3"><i class="fas fa-id-card"></i> Identificación</h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3 campo-condicional" id="dniField">
                                    {{ form.dni.label(class="form-label fw-bold") }}
                                    {{ form.dni(class="form-control" + (" is-invalid" if form.dni.errors else "")) }}
                                    {% if form.dni.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.dni.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        <i class="fas fa-id-badge"></i> Requerido para profesionales y administradores
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3 campo-condicional" id="matriculaField" style="display: none;">
                                    {{ form.codigo_matricula.label(class="form-label fw-bold") }}
                                    {{ form.codigo_matricula(class="form-control" + (" is-invalid" if form.codigo_matricula.errors else "")) }}
                                    {% if form.codigo_matricula.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.codigo_matricula.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        <i class="fas fa-graduation-cap"></i> Código único del estudiante
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Información del rol seleccionado -->
                            <div class="alert alert-info" id="infoRol">
                                <i class="fas fa-info-circle"></i>
                                <strong>Estudiante:</strong> Acceso a agendar citas y ver su historial médico. Usa código de matrícula para iniciar sesión.
                            </div>
                        </div>

                        <div class="form-section mb-4">
                            <h6 class="mb-3"><i class="fas fa-key"></i> Credenciales de Acceso</h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.password.label(class="form-label fw-bold") }}
                                    {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else "")) }}
                                    {% if form.password.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.password.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        <i class="fas fa-shield-alt"></i> Mínimo 6 caracteres
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    {{ form.confirm_password.label(class="form-label fw-bold") }}
                                    {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else "")) }}
                                    {% if form.confirm_password.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.confirm_password.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="help-text">
                                        <i class="fas fa-check-double"></i> Debe coincidir con la contraseña
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen del usuario a crear -->
                        <div class="alert alert-light border">
                            <h6><i class="fas fa-clipboard-list"></i> Resumen</h6>
                            <p class="mb-1" id="resumenUsuario">
                                Se creará un usuario <span id="resumenRol">estudiante</span> que podrá iniciar sesión con:
                            </p>
                            <ul class="mb-0">
                                <li id="resumenCredencial">Código de matrícula + contraseña</li>
                                <li id="resumenPermisos">Acceso a funciones de estudiante</li>
                            </ul>
                        </div>

                        <!-- Botones de acción -->
                        <div class="row">
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-user-plus"></i> Crear Usuario
                                </button>
                            </div>
                            <div class="col-md-6">
                                <a href="{{ url_for('reportes.gestion_usuarios') }}" class="btn btn-secondary btn-lg w-100">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Configuración de roles y sus características
const rolesConfig = {
    'PACIENTE': {
        nombre: 'estudiante',
        credencial: 'Código de matrícula + contraseña',
        permisos: 'Acceso a agendar citas y ver historial médico',
        info: '<strong>Estudiante:</strong> Acceso a agendar citas y ver su historial médico. Usa código de matrícula para iniciar sesión.',
        mostrarDni: false,
        mostrarMatricula: true
    },
    'PROFESIONAL': {
        nombre: 'profesional médico',
        credencial: 'DNI + contraseña',
        permisos: 'Acceso a gestionar citas y realizar consultas médicas',
        info: '<strong>Profesional:</strong> Acceso a gestionar citas médicas y registrar consultas. Usa DNI para iniciar sesión.',
        mostrarDni: true,
        mostrarMatricula: false
    },
    'ADMINISTRADOR': {
        nombre: 'administrador',
        credencial: 'DNI + contraseña',
        permisos: 'Acceso completo al sistema y panel administrativo',
        info: '<strong>Administrador:</strong> Acceso completo al sistema, gestión de usuarios y reportes. Usa DNI para iniciar sesión.',
        mostrarDni: true,
        mostrarMatricula: false
    }
};

// Función para actualizar la interfaz según el rol seleccionado
function actualizarInterfazRol() {
    const rolSelect = document.getElementById('rolSelect');
    const rolSeleccionado = rolSelect.value;
    const config = rolesConfig[rolSeleccionado];
    
    if (!config) return;
    
    // Mostrar/ocultar campos de identificación
    const dniField = document.getElementById('dniField');
    const matriculaField = document.getElementById('matriculaField');
    
    if (config.mostrarDni) {
        dniField.style.display = 'block';
        matriculaField.style.display = 'none';
    } else {
        dniField.style.display = 'none';
        matriculaField.style.display = 'block';
    }
    
    // Actualizar información del rol
    const infoRol = document.getElementById('infoRol');
    infoRol.innerHTML = '<i class="fas fa-info-circle"></i> ' + config.info;
    
    // Actualizar resumen
    document.getElementById('resumenRol').textContent = config.nombre;
    document.getElementById('resumenCredencial').textContent = config.credencial;
    document.getElementById('resumenPermisos').textContent = config.permisos;
}

// Event listener para cambios en el rol
document.getElementById('rolSelect').addEventListener('change', actualizarInterfazRol);

// Validación en tiempo real de confirmación de contraseña
document.getElementById('confirm_password').addEventListener('input', function() {
    const password = document.getElementById('password').value;
    const confirmPassword = this.value;
    
    if (confirmPassword && password !== confirmPassword) {
        this.classList.add('is-invalid');
        this.classList.remove('is-valid');
    } else if (confirmPassword && password === confirmPassword) {
        this.classList.add('is-valid');
        this.classList.remove('is-invalid');
    } else {
        this.classList.remove('is-valid', 'is-invalid');
    }
});

// Validación de fortaleza de contraseña
document.getElementById('password').addEventListener('input', function() {
    const password = this.value;
    const helpText = this.parentNode.querySelector('.help-text');
    
    if (password.length < 6) {
        helpText.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Mínimo 6 caracteres';
    } else if (password.length < 8) {
        helpText.innerHTML = '<i class="fas fa-check text-success"></i> Contraseña válida';
    } else {
        helpText.innerHTML = '<i class="fas fa-check-circle text-success"></i> Contraseña fuerte';
    }
});

// Inicializar la interfaz con el rol por defecto
document.addEventListener('DOMContentLoaded', function() {
    actualizarInterfazRol();
});

// Prevenir envío del formulario si hay errores de validación
document.querySelector('form').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (password !== confirmPassword) {
        e.preventDefault();
        alert('Las contraseñas no coinciden. Por favor, verifique los datos.');
        return false;
    }
    
    // Mostrar indicador de carga
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando Usuario...';
    submitBtn.disabled = true;
});
</script>
{% endblock %}