{% extends "admin_base.html" %}

{% block title %}Crear Usuario - Sistema M√©dico Universitario{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="admin-header">
    <div>
        <h1 class="admin-header-title">Crear Nuevo Usuario</h1>
        <p class="admin-header-subtitle">Formulario para registrar usuarios en el sistema m√©dico</p>
        <small class="admin-status">Administraci√≥n de usuarios del sistema</small>
    </div>
    <div class="admin-header-actions">
        <a href="{{ url_for('reportes.gestion_usuarios') }}" class="admin-btn admin-btn-secondary">
            <i class='bx bx-arrow-back'></i>
            Volver a Usuarios
        </a>
    </div>
</div>

<!-- Formulario de Usuario -->
<div class="admin-table-container">
    <div class="admin-table-header">
        <div class="admin-table-title">Informaci√≥n del Usuario</div>
        <div style="color: var(--admin-text-secondary); font-size: 14px;">
            Complete todos los campos para registrar un nuevo usuario
        </div>
    </div>
    <div style="padding: 30px;">
        <form method="POST" autocomplete="off">
            {{ form.hidden_tag() if form else '' }}
            
            <!-- Datos Generales -->
            <div style="margin-bottom: 30px;">
                <h5 style="color: var(--admin-text-primary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class='bx bx-user'></i> Datos Generales
                </h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--admin-text-primary);">
                            <i class='bx bx-edit'></i> Nombre Completo *
                        </label>
                        <input type="text" name="nombre" required 
                               style="width: 100%; padding: 12px; border: 1px solid var(--admin-border); border-radius: 6px; background: var(--admin-bg);"
                               placeholder="Ej: Dr. Juan P√©rez Garc√≠a">
                        <small style="color: var(--admin-text-secondary); font-size: 12px;">Ingrese el nombre completo del usuario</small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--admin-text-primary);">
                            <i class='bx bx-user-check'></i> Rol del Usuario *
                        </label>
                        <select name="rol" required id="rolSelect" onchange="toggleFields()"
                                style="width: 100%; padding: 12px; border: 1px solid var(--admin-border); border-radius: 6px; background: var(--admin-bg);">
                            <option value="">Seleccionar rol</option>
                            <option value="PACIENTE">üë®‚Äçüéì Estudiante</option>
                            <option value="PROFESIONAL">üë®‚Äç‚öïÔ∏è Profesional</option>
                            <option value="ADMINISTRADOR">üë®‚Äçüíº Administrador</option>
                        </select>
                        <small style="color: var(--admin-text-secondary); font-size: 12px;">Seleccione los permisos de acceso</small>
                    </div>
                </div>
            </div>
            
            <!-- Informaci√≥n del Rol -->
            <div id="roleInfo" style="display: none; margin-bottom: 30px; background: var(--admin-secondary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--admin-primary);">
                <h6 style="color: var(--admin-text-primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                    <i class='bx bx-info-circle'></i> Informaci√≥n del Rol
                </h6>
                <div id="roleDescription" style="color: var(--admin-text-secondary); font-size: 14px;"></div>
            </div>
            
            <!-- Identificaci√≥n -->
            <div style="margin-bottom: 30px;">
                <h5 style="color: var(--admin-text-primary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class='bx bx-id-card'></i> Identificaci√≥n
                </h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div id="dniField">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--admin-text-primary);">
                            <i class='bx bx-card'></i> DNI
                        </label>
                        <input type="text" name="dni" maxlength="8" pattern="[0-9]{8}"
                               style="width: 100%; padding: 12px; border: 1px solid var(--admin-border); border-radius: 6px; background: var(--admin-bg);"
                               placeholder="Ej: 12345678">
                        <small style="color: var(--admin-text-secondary); font-size: 12px;">Solo n√∫meros, 8 d√≠gitos</small>
                    </div>
                    
                    <div id="matriculaField" style="display: none;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--admin-text-primary);">
                            <i class='bx bx-bookmark'></i> C√≥digo de Matr√≠cula
                        </label>
                        <input type="text" name="codigo_matricula" maxlength="6" pattern="[0-9]{6}"
                               style="width: 100%; padding: 12px; border: 1px solid var(--admin-border); border-radius: 6px; background: var(--admin-bg);"
                               placeholder="Ej: 123456">
                        <small style="color: var(--admin-text-secondary); font-size: 12px;">Solo n√∫meros, 6 d√≠gitos</small>
                    </div>
                </div>
            </div>
            
            <!-- Informaci√≥n Acad√©mica (Solo para Estudiantes) -->
            <div id="academicSection" style="display: none; margin-bottom: 30px;">
                <h5 style="color: var(--admin-text-primary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class='bx bx-school'></i> Informaci√≥n Acad√©mica
                </h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--admin-text-primary);">
                            <i class='bx bx-book'></i> Carrera
                        </label>
                        <input type="text" name="carrera"
                               style="width: 100%; padding: 12px; border: 1px solid var(--admin-border); border-radius: 6px; background: var(--admin-bg);"
                               placeholder="Ej: Medicina, Enfermer√≠a, Ingenier√≠a">
                        <small style="color: var(--admin-text-secondary); font-size: 12px;">Carrera universitaria del estudiante</small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--admin-text-primary);">
                            <i class='bx bx-map'></i> Procedencia
                        </label>
                        <select name="procedencia"
                                style="width: 100%; padding: 12px; border: 1px solid var(--admin-border); border-radius: 6px; background: var(--admin-bg);">
                            <option value="">Seleccionar procedencia</option>
                            <option value="Puno">Puno (Ciudad)</option>
                            <option value="Juliaca">Juliaca</option>
                            <option value="Ilave">Ilave</option>
                            <option value="Yunguyo">Yunguyo</option>
                            <option value="Desaguadero">Desaguadero</option>
                            <option value="Ayaviri">Ayaviri</option>
                            <option value="Putina">Putina</option>
                            <option value="Sandia">Sandia</option>
                            <option value="Macusani">Macusani</option>
                            <option value="Crucero">Crucero</option>
                            <option value="Az√°ngaro">Az√°ngaro</option>
                            <option value="Lampa">Lampa</option>
                            <option value="Juli">Juli</option>
                            <option value="Pomata">Pomata</option>
                            <option value="Zepita">Zepita</option>
                            <option value="Pilcuyo">Pilcuyo</option>
                            <option value="Huancan√©">Huancan√©</option>
                            <option value="Moho">Moho</option>
                            <option value="Conima">Conima</option>
                            <option value="Tilali">Tilali</option>
                            <option value="Taraco">Taraco</option>
                            <option value="Otro">Otro lugar</option>
                        </select>
                        <small style="color: var(--admin-text-secondary); font-size: 12px;">Distrito o provincia de origen para el mapa</small>
                    </div>
                </div>
            </div>
            
            <!-- Credenciales -->
            <div style="margin-bottom: 30px;">
                <h5 style="color: var(--admin-text-primary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class='bx bx-lock'></i> Credenciales de Acceso
                </h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--admin-text-primary);">
                            <i class='bx bx-key'></i> Contrase√±a *
                        </label>
                        <input type="password" name="password" required id="password"
                               style="width: 100%; padding: 12px; border: 1px solid var(--admin-border); border-radius: 6px; background: var(--admin-bg);"
                               placeholder="M√≠nimo 6 caracteres">
                        <small style="color: var(--admin-text-secondary); font-size: 12px;">Debe contener letras y n√∫meros</small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--admin-text-primary);">
                            <i class='bx bx-lock-open'></i> Confirmar Contrase√±a *
                        </label>
                        <input type="password" name="confirm_password" required id="confirmPassword"
                               style="width: 100%; padding: 12px; border: 1px solid var(--admin-border); border-radius: 6px; background: var(--admin-bg);"
                               placeholder="Repita la contrase√±a">
                        <small style="color: var(--admin-text-secondary); font-size: 12px;">Debe coincidir con la contrase√±a anterior</small>
                    </div>
                </div>
            </div>
            
            <!-- Botones de Acci√≥n -->
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 30px;">
                <a href="{{ url_for('reportes.gestion_usuarios') }}" class="admin-btn admin-btn-secondary">
                    <i class='bx bx-x'></i> Cancelar
                </a>
                <button type="submit" class="admin-btn admin-btn-success">
                    <i class='bx bx-check-circle'></i> Crear Usuario
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function toggleFields() {
    const rolSelect = document.getElementById('rolSelect');
    const roleInfo = document.getElementById('roleInfo');
    const roleDescription = document.getElementById('roleDescription');
    const dniField = document.getElementById('dniField');
    const matriculaField = document.getElementById('matriculaField');
    const academicSection = document.getElementById('academicSection');
    
    const selectedRole = rolSelect.value;
    
    if (selectedRole) {
        roleInfo.style.display = 'block';
        
        if (selectedRole === 'PACIENTE') {
            roleDescription.innerHTML = 'Los estudiantes pueden acceder a consultas m√©dicas, gestionar su perfil y agendar citas. Se requiere informaci√≥n acad√©mica y de procedencia para el mapa de Puno.';
            dniField.style.display = 'none';
            matriculaField.style.display = 'block';
            academicSection.style.display = 'block';
            document.querySelector('input[name="dni"]').required = false;
            document.querySelector('input[name="codigo_matricula"]').required = true;
            document.querySelector('input[name="carrera"]').required = true;
        } else {
            roleDescription.innerHTML = selectedRole === 'PROFESIONAL' ? 
                'Los profesionales pueden atender consultas, gestionar citas y acceder al historial m√©dico.' :
                'Los administradores tienen acceso completo al sistema, incluyendo gesti√≥n de usuarios y reportes.';
            dniField.style.display = 'block';
            matriculaField.style.display = 'none';
            academicSection.style.display = 'none';
            document.querySelector('input[name="dni"]').required = true;
            document.querySelector('input[name="codigo_matricula"]').required = false;
            document.querySelector('input[name="carrera"]').required = false;
        }
    } else {
        roleInfo.style.display = 'none';
        dniField.style.display = 'block';
        matriculaField.style.display = 'none';
        academicSection.style.display = 'none';
    }
}

// Validaci√≥n de contrase√±as
document.addEventListener('DOMContentLoaded', function() {
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirmPassword');
    const matriculaInput = document.querySelector('input[name="codigo_matricula"]');
    const dniInput = document.querySelector('input[name="dni"]');
    
    function validatePasswords() {
        if (password.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Las contrase√±as no coinciden');
        } else {
            confirmPassword.setCustomValidity('');
        }
    }
    
    // Validaci√≥n de matr√≠cula - solo n√∫meros, m√°ximo 6 d√≠gitos
    if (matriculaInput) {
        matriculaInput.addEventListener('input', function(e) {
            // Remover caracteres no num√©ricos
            this.value = this.value.replace(/[^0-9]/g, '');
            // Limitar a 6 d√≠gitos
            if (this.value.length > 6) {
                this.value = this.value.slice(0, 6);
            }
        });
    }
    
    // Validaci√≥n de DNI - solo n√∫meros, m√°ximo 8 d√≠gitos
    if (dniInput) {
        dniInput.addEventListener('input', function(e) {
            // Remover caracteres no num√©ricos
            this.value = this.value.replace(/[^0-9]/g, '');
            // Limitar a 8 d√≠gitos
            if (this.value.length > 8) {
                this.value = this.value.slice(0, 8);
            }
        });
    }
    
    password.addEventListener('change', validatePasswords);
    confirmPassword.addEventListener('keyup', validatePasswords);
});
</script>
{% endblock %}